# Flink Network Stack



Apache Flink 中的 Network Stack 是其流式处理引擎的主要组件之一，它负责在分布式系统中进行数据交换和通信。

1. **数据传输方式**: 在Flink中，数据通过网络在任务操作符之间传输。Flink 网络堆栈使用 TCP/IP 套接字进行传输，并为每个连接配备了两个缓冲池。一个用于数据的接收，一个用于数据的发送。

2. **Credit-based Flow Control**: Flink 网络堆栈采用信用基础流程控制机制，以解决背压和数据拥堵问题。它允许接收者通过控制 "credit" 数量来动态调整其数据接收速度。

3. **序列化和反序列化**: 网络层将数据以序列化的方式传输，从而可以在不同的机器之间进行交换。然后，在接收方，数据被反序列化并通过 Record Deserializer 转化为 Java 对象。

4. **Large Records Handling**: Flink 对于处理大记录采用了特殊的处理方式。例如，如果一条记录不能完全地装入一个网络缓冲区，那么 Flink 会将这条记录分成多个较小的片段进行传输。

5. **交互性和异步性**: Flink Network Stack 采用异步和非阻塞的设计，以支持高吞吐量，并减少任务在数据读取和处理时的等待时间。

6. **缓冲与排队**: 法律在发送和接收侧都使用了缓冲区和队列，以优化网络传输。

7. **可扩展性和容错性**: Flink 的网络堆栈被设计为能够支持大量的网络连接，并且在出现网络故障时，它能够通过内部机制进行恢复。



##  Credit-based Flow Control
Credit-based Flow Control 是 Apache Flink 从 1.5 版本开始引入的特性，主要用于解决数据背压(backpressure)问题。它基于生产者-消费者模型，允许消费者控制其接收数据的速度。

实现这种流控制的基本思想是“credit”。Credit代表了接收者可以处理的数据量。作为发送者的任务可能会有很多缓冲区中预填充了数据要发送，但是它只有在确认接收者有足够的credit（即有足够的空间接收新数据），才会真正发送数据。

下面是 Credit-based Flow Control 的基本工作流程：

1. **初始化**：算子启动时，接收者（下游任务）分配给每个发送者（上游任务）一定数量的初始credit。

2. **数据发送**：只有当发送者检查到目标接收者还有剩余credit时，才会把数据发送出去。每发送一个网络缓冲区的数据，就会消耗掉一份credit。

3. **credit的返还**：当接收者消耗了一个网络缓冲区中的数据，它就会向发送者返还一份credit。这表示接收者已经准备好接收新的数据了。

4. **数据拥塞与背压**：如果接收者处理不过来输入的数据，它的credit就会逐渐减少。当所有credit用完时，发送者将停止数据的发送，等待新的credit。这样就形成了一种自我调节的机制，发送者不能无限制地生产数据，而是要根据消费者的处理能力调整速率。



